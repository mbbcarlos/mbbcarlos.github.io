<!doctype html><html><head><title>World Composition: Level loading/unloading</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/layouts/main.css><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/navigators/navbar.css><link href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css><link rel=icon type=image/png href=/images/favicon_hu8376fd15465fef26ffe66b6bcf0ca686_13669_42x0_resize_box_2.png><link rel=stylesheet href=/css/style.css><meta name=description content="How to know what and when levels are being loaded and unloaded"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css><link rel=stylesheet href=/css/layouts/single.css><link rel=stylesheet href=/css/navigators/sidebar.css></head><body data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button onclick=toggleSidebar()>
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=/><img src=/images/main-logo_hu864bbe108f1be1ae04b57f7f2fd9d631_5637_42x0_resize_box_2.png>Marta Carlos</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button onclick=toggleTOC()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"></ul></div></div><img src=/images/main-logo_hu864bbe108f1be1ae04b57f7f2fd9d631_5637_42x0_resize_box_2.png class=d-none id=main-logo>
<img src=/images/inverted-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_42x0_resize_box_2.png class=d-none id=inverted-logo></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><input type=text placeholder=Search data-search id=search-box><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts data-filter=all>Posts</a></li><div class=subtree><li><i class="fas fa-minus-circle"></i><a class=active href=/posts/unreal-engine/>Unreal Engine 4</a><ul class=active><li><a class=active href=/posts/unreal-engine/level-streamming/>World Composition</a></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(https://mbbcarlos.github.io/images/default-hero.jpg)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/perfil.jpg><h5 class=author-name>Marta Carlos</h5><p>February 27, 2021</p></div><div class=title><h1>World Composition: Level loading/unloading</h1></div><div class=post-content id=post-content><h2 id=tldr-what-you-will-get-from-this-post-codecode>TLDR: What you will get from this post ðŸ¤”</h2><p>After reading this post, you should have a basic understanding of:</p><ul><li>what is World Composition;</li><li>pros and cons of World Composition;</li><li>my solution to some of these problems;</li></ul><h2 id=basics-what-is-world-composition>Basics: What is World Composition?</h2><p>To put it bluntly, World Composition is a system designed by Epic to manage large worlds: a system where you don&rsquo;t have to worry about the loading and unloading levels logic and let the streamming distance do its thing. It resolves around reading sub-level information directly from the file system, making it more optimized and taking the burden of all this logic from the programmer.</p><p>With World Composition, you can achieve many great things regarding large areas, e.g., if you have a large heightmap, you can divide into <strong>tiles</strong> and upload them directly using World Composition - you only have to make sure the names are something like TileName_X0_Y0, TileName_X0_Y1 and so on.<div style=margin-top:3rem></div></p><img src=/posts/unreal-engine/tiled_heightmap_import.webp alt="Import Tiled Landscape by Epic Games" class=center><div style=margin-top:3rem></div><p>I won&rsquo;t go into more detail about <em>what is it</em> because this should be nothing new, if you&rsquo;ve stumbled across this blog post, you&rsquo;ve probably read all the <a href=https://docs.unrealengine.com/en-US/BuildingWorlds/LevelStreaming/WorldBrowser/index.html>documentation</a> regarding this (even tho, it&rsquo;s not much). But, if it comes to it, I could do a more detailed post about how to tile a heightmap and configurations.</p><h2 id=then-where-is-the-problem>Then where is the problem?</h2><p>The moment you pass the &ldquo;beginners&rdquo; stage of World Composition (or any game related aspect) and actually want to built some logic that will depend on the loading and unloading of tiles&mldr; this is where we start facing our first set of problems.</p><p><strong>How so?</strong> You may ask, well&mldr; Imagine you want to integrate some time of data at run time - there&rsquo;s no way this data can be added to the tile on the editor and save it there, no you want to add <em>pure</em> dynmaic data that should not be &ldquo;hard-coded&rdquo; into the world. To make it more clear, imagine someone outside the game drew an area of interest (AOI) and now you want this area to be replicated into your game world and mapped directly on the landscape/tiles.</p><p>Okay, so with this example in mind, you may still ask? <strong>Where exactly is the problem here?</strong> Imagine this area covers more than one tile worth of game &ldquo;area&rdquo;: will you have this area be drawn on tiles that have still not been loaded? It could be a solution but what if it&rsquo;s a truly <strong>big</strong> area that covers most of the game map except 2 or 3 tiles?</p><p>I had similar problems before, I specifically needed to know when certain tiles would be loaded into memory so I could load the dynamic information that was to be placed there. Since I couldn&rsquo;t find any way for an Actor to know when a certain tile was loaded, I had to come up with something.</p><h2 id=my-approach-an-overview>My Approach: An Overview</h2><p>The solution I came up with is very intertwined with what I was already working with: for every object I wanted to spawn on specific tiles, I knew exactly what those tiles' package names were.</p><p>With this information, my solution is a little bit based on the <strong>Observer Pattern</strong> but with a slight difference. So, we have our interested object, <strong>Subscriber</strong> and what our <strong>Subscriber</strong> Actors want is to dump one or more tiles' names to somewhere and be notified when these were loaded and unloaded. First things to discuss is &ldquo;Composition or Inheritance?&rdquo; , which should we use? In my case, I opted for Composotion (<em>aka</em> ActorComponents) since, in this context, it is much more scalable and I can add it to already existing Actors without going through the pain of refactoring everything.</p><p>Okay, Components, got it. Now we need to decided what exactly this component is gonna do and for that, let&rsquo;s just define what we need it to do:</p><ul><li>receive the names of the tiles we are interested in</li><li>for each tile, bind to their loading and unloading</li><li>when one is loaded/unloaded, notify us and that notification must come with the tile&rsquo;s name</li></ul><p>Now we are ready to start implementing our component.</p><h2 id=my-approach-implementation>My Approach: Implementation</h2><p>Before anything else: I implemented it using Blueprints but it&rsquo;s also very possible to use C++ for this. Maybe, one day I will make another post with the C++ implementation, but for now, Blueprints will have to do.</p><p>Now, we just have a small thing to remember: with levels names, we have access to a 4 events related to level streaming:</p><div style=margin-top:3rem></div><img src=/posts/unreal-engine/levels-events.png alt="Event Dispatchers related to level streaming" class=center><div style=margin-top:3rem></div><p>But there&rsquo;s a little thing that makes this process a little bothersome: when we are interested in binding to multiple levels, we have no way of knowing which one of the levels actually loaded!</p><p>Naturally, the first thing we need to implement is for each tile the component&rsquo;s owner is interested in, we will bind to On Level Shown and On Level Hidden.</p><div style=margin-top:3rem></div><img src=/posts/unreal-engine/bind-to-levels.png alt="Binding to levels" class=center><div style=margin-top:3rem></div><img src=/posts/unreal-engine/bind-to-level-load.png alt="Binding to level load" class=center><div style=margin-top:3rem></div><img src=/posts/unreal-engine/bind-to-level-unload.png alt="Binding to level unload" class=center><div style=margin-top:3rem></div><p>Additionally, we will also implement another function that receives a singular level/tile name and adds it to the component&rsquo;s <strong>LevelList</strong>.</p><div style=margin-top:3rem></div><img src=/posts/unreal-engine/add-level.png alt="Adding level to list" class=center><div style=margin-top:3rem></div><p>Now, we will define two event dispatchers, one to notify the &ldquo;owner&rdquo; that a certain tile was loaded and the same for unloading - our events will have one input: a String with the level&rsquo;s name. To keep it simple, I&rsquo;ll name them <strong>OnLevelLoaded</strong> and <strong>OnLevelUnloaded</strong>.</p><div style=margin-top:3rem></div><img src=/posts/unreal-engine/event-dispatchers.png alt="The event dispatchers" class=center>
<img src=/posts/unreal-engine/dispatcher-details.png alt="The event dispatchers" class=center><div style=margin-top:3rem></div><p>Next, what do we do now? We have now bound ourselves to different streaming events but they all end up in the same function&mldr; It&rsquo;s time to figure out which level(s) notified us and for that we will need a new variable: <strong>Active Levels</strong>, an array of level names. sEvery time the component is notified of a level loading (function <strong>OnLevelLoaded</strong> is called), we will go through every level we are interested in and check if this one went from not-loaded/not-visible to loaded/visible. We do this by storing new active levels (new visible/loaded levels) in our <strong>Active Levels</strong> array and call <strong>OnLevelLoaded</strong> (input being the level name in question). If the current level (in the iteration) was already inserted to <strong>Active Levels</strong> we don&rsquo;t have to do anything.</p><div style=margin-top:3rem></div><img src=/posts/unreal-engine/on-level-loaded.png alt="On Level Loaded pt. 1" class=center><div style=margin-top:3rem></div><img src=/posts/unreal-engine/on-level-loaded-2.png alt="On Level Loaded pt. 2" class=center><div style=margin-top:3rem></div><p>Now, we basically apply the same logic to <strong>OnLevelUnloaded</strong></p><div style=margin-top:3rem></div><img src=/posts/unreal-engine/on-level-unloaded.png alt="On Level UnLoaded pt. 1" class=center><div style=margin-top:3rem></div><img src=/posts/unreal-engine/on-level-unloaded-2.png alt="On Level UnLoaded pt. 2" class=center><div style=margin-top:3rem></div><p>Now, all that&rsquo;s left to do is call the component&rsquo;s binding functions and bind to our two new event dispatchers.</p><div style=margin-top:3rem></div><img src=/posts/unreal-engine/owner-binds.png alt="Owner calls binds" class=center><div style=margin-top:3rem></div><p>And voila! It&rsquo;s done!</p><h2 id=ending-note>Ending Note</h2><p>If anything is confusing or you think some parts of the implementation can be optimized, please do share!</p></div><div class=btn-improve-page><a href=https://github.com/mbbcarlos/mbbcarlos.github.io/edit//content/posts/unreal-engine/level-streamming.md><i class="fas fa-code-branch"></i>Improve this page</a></div><hr><div class="row next-prev-navigator"></div><hr></div></div></div></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#tldr-what-you-will-get-from-this-post-codecode>TLDR: What you will get from this post ðŸ¤”</a></li><li><a href=#basics-what-is-world-composition>Basics: What is World Composition?</a></li><li><a href=#then-where-is-the-problem>Then where is the problem?</a></li><li><a href=#my-approach-an-overview>My Approach: An Overview</a></li><li><a href=#my-approach-implementation>My Approach: Implementation</a></li><li><a href=#ending-note>Ending Note</a></li></ul></nav></div></div></section></div><footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=#about>About</a></li><li class=nav-item><a class=smooth-scroll href=#skills>Skills</a></li><li class=nav-item><a class=smooth-scroll href=#experiences>Experiences</a></li><li class=nav-item><a class=smooth-scroll href=#projects>Projects</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><span>Email:</span> <span>mbbcarlos@gmail.com</span></li></ul></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hossainemruz/toha target=#><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_2.png>
Toha</a></div><div class="col-md-4 text-center">Â© 2021 Copyright.</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script src=/js/jquery-3.4.1.min.js></script><script src=/js/popper.min.js></script><script src=/js/bootstrap.min.js></script><script src=/js/navbar.js></script><script src=/js/main.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script><script src=/js/single.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>